import "./globals.css";
import { Inter } from "next/font/google";
import Image from "next/image";
import { MobileSearch, SearchbarDistributeTop } from "../components/searchbar";
import QueryContext from "../components/QueryContext";
import Link from "next/link";
import { redirect } from "next/navigation";
import ActiveLink from "../components/ActiveLink";
// import OfflineBanner from "@/components/OfflineBanner";
// import "@/worker/offline_worker";
import { AuthControls } from "@/components/AuthControls";
import { HideOnRoute } from "@/components/HideOnRoutes";
import { Suspense } from "react";
import { SnackContextProvider } from "@/components/SnackContext";
import { CartButton } from "@/components/cart/CartButton";
// import { TurboLink } from "@/components/Turbolink";
import { ClientInspector } from "@/components/ClientInspector";

const atkinsonHyper = Inter({
  weight: ["100", "200", "300", "400", "500", "600", "700"],
  subsets: ["latin"],
  preload: true,
});

export const metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
  modal,
}: {
  children: React.ReactNode;
  modal: React.ReactNode;
}) {
  const handleSubmitSearch = async (data: FormData) => {
    "use server";
    redirect(`/browse?keyword=${data.get("keyword")}`);
  };

  return (
    <html lang="en" className="scroll-pt-[116px]">
      <ClientInspector />
      <QueryContext>
        <body className={atkinsonHyper.className + " bg-default"}>
          <header
            className="px-4 lg:px-24 xl:px-44 py-2 min-h-[56px]
            flex justify-between 
            bg-paper 
            fixed top-0 w-full z-20"
          >
            <Link href={`/`}>
              <Image
                src={
                  "https://firebasestorage.googleapis.com/v0/b/images-b3099.appspot.com/o/269863143_480068400349256_2256909955739492979_n.png?alt=media&token=3a12e3c5-a40d-4747-8607-a42eb4917cd2"
                }
                alt={"logo-of-a-penguine"}
                width={40}
                height={40}
              />
            </Link>
            <Suspense>
              <HideOnRoute
                matches={[{ pathname: "/login" }, { pathname: "/signup" }]}
              >
                <div className="flex gap-4 text-sm pl-4 text-white_primary items-center">
                  <form
                    className="hidden h-full sm:block mr-8"
                    action={handleSubmitSearch}
                  >
                    <SearchbarDistributeTop />
                  </form>
                  {/* @ts-expect-error Server Component */}
                  <CartButton />
                  {/* @ts-expect-error Server Component */}
                  <AuthControls />
                </div>
              </HideOnRoute>
            </Suspense>
          </header>

          <Suspense>
            <HideOnRoute
              matches={[
                { pathname: "/order" },
                { pathname: "/login" },
                { pathname: "/signup" },
                { pathname: "/cart" },
                { pathname: "/checkout" },
                { pathname: "^.*/order/", regex: true },
              ]}
            >
              <nav className="px-4 lg:px-24 xl:px-44 flex gap-4 fixed w-full top-[56px] z-10 bg-default">
                <div
                  className={
                    "absolute inset-0 pointer-events-none " +
                    " [--extended-by:50px] [--cutoff:calc(100%-var(--extended-by))] [--blur:25px] " +
                    " bottom-[calc(-1*var(--extended-by))] " +
                    " [-webkit-mask-image:linear-gradient(to_bottom,_black_0,_black_var(--cutoff),_transparent_var(--cutoff))] " +
                    " [-webkit-backdrop-filter:blur(var(--blur))] " +
                    " [backdrop-filter:blur(var(--blur))] "
                  }
                ></div>
                <ActiveLink
                  matches={[{ name: "/", exact: true }, { name: "discover" }]}
                >
                  <Link
                    className="text-sm text-white/60 py-4 hover:text-white_primary transition-colors z-[1]"
                    href={"/"}
                  >
                    Discover
                  </Link>
                </ActiveLink>
                <ActiveLink match="browse">
                  <Link
                    className="text-sm text-white/60 py-4 hover:text-white_primary transition-colors z-[1]"
                    href={"/browse"}
                  >
                    Browse
                  </Link>
                </ActiveLink>
              </nav>
              {/* <div className="top-[108px] fixed w-full z-10"> */}
              {/*   <TurboLink /> */}
              {/* </div> */}
            </HideOnRoute>
          </Suspense>
          <main className="px-4 lg:px-24 xl:px-44 pt-[116px] pb-16 text-white_primary max-w-[1952px] mx-auto">
            <SnackContextProvider>{children}</SnackContextProvider>
            {modal}
          </main>
          <Suspense>
            <HideOnRoute
              matches={[
                { pathname: "/login" },
                { pathname: "/signup" },
                { pathname: "/browse" },
                { pathname: "/cart" },
                { pathname: "/checkout" },
                { pathname: "^.*/order/", regex: true },
              ]}
            >
              <form
                className="fixed bottom-0 left-0 right-0 p-2 bg-default block sm:hidden z-50"
                action={handleSubmitSearch}
              >
                <MobileSearch />
              </form>
            </HideOnRoute>
          </Suspense>
        </body>
      </QueryContext>
    </html>
  );
}
